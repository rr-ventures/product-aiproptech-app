{% extends "base.html" %}
{% block page_title %}Feasibility ‚Äî {{ deal.address }} ‚Äî Property Ops{% endblock %}
{% block title %}Feasibility Engine{% endblock %}

{% block breadcrumb %}
<div class="breadcrumb">
  <a href="/">Deals</a> <span class="sep">‚Ä∫</span> <a href="/deals/{{ deal.id }}">{{ deal.address }}</a> <span class="sep">‚Ä∫</span> Feasibility
</div>
{% endblock %}

{% block content %}
{% if not cma_data %}
  <div class="alert alert-warning">
    No CMA data found for this deal. <a href="/deals/{{ deal.id }}/cma" style="text-decoration:underline">Run CMA first</a> to auto-populate values, or enter them manually below.
  </div>
{% else %}
  <div class="alert alert-success">
    CMA data loaded ‚Äî value range: <strong>${{ "{:,.0f}".format(cma_val.value_range_low|default(0)) }} ‚Äì ${{ "{:,.0f}".format(cma_val.value_range_high|default(0)) }}</strong>
  </div>
{% endif %}

<form id="feasibilityForm" onsubmit="runFeasibility(event, '{{ deal.id }}')">
  <div class="card mb-3">
    <div class="card-header"><span class="card-title">Deal Inputs</span></div>
    <div class="card-body">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Asking Price ($)</label>
          <input class="form-input" name="asking_price" type="number" value="{{ feas_inputs.asking_price|default(0) }}" required>
        </div>
        <div class="form-group">
          <label class="form-label">Your Purchase Price ($)</label>
          <input class="form-input" name="purchase_price" type="number" value="{{ feas_inputs.purchase_price|default(0) }}" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Renovation Budget ($)</label>
          <input class="form-input" name="reno_budget" type="number" value="{{ feas_inputs.reno_budget|default(0) }}">
        </div>
        <div class="form-group">
          <label class="form-label">Expected Sale Price ($)</label>
          <input class="form-input" name="post_reno_sale_price" type="number" value="{{ feas_inputs.post_reno_sale_price|default(cma_val.value_range_high|default(0)) }}">
          <div class="form-hint">Use CMA high or your post-reno estimate</div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Hold Period (months)</label>
          <input class="form-input" name="hold_period_months" type="number" value="{{ feas_inputs.hold_period_months|default(defaults.deal_parameters.default_hold_period_months|default(6)) }}">
        </div>
        <div class="form-group">
          <label class="form-label">State</label>
          <select class="form-select" name="state">
            <option value="NSW" {% if feas_inputs.state|default('NSW') == 'NSW' %}selected{% endif %}>NSW</option>
            <option value="VIC" {% if feas_inputs.state == 'VIC' %}selected{% endif %}>VIC</option>
            <option value="QLD" {% if feas_inputs.state == 'QLD' %}selected{% endif %}>QLD</option>
            <option value="SA" {% if feas_inputs.state == 'SA' %}selected{% endif %}>SA</option>
            <option value="WA" {% if feas_inputs.state == 'WA' %}selected{% endif %}>WA</option>
            <option value="TAS" {% if feas_inputs.state == 'TAS' %}selected{% endif %}>TAS</option>
            <option value="ACT" {% if feas_inputs.state == 'ACT' %}selected{% endif %}>ACT</option>
            <option value="NT" {% if feas_inputs.state == 'NT' %}selected{% endif %}>NT</option>
          </select>
        </div>
      </div>
    </div>
    <div class="card-footer">
      <button type="submit" class="btn btn-primary">Calculate Feasibility</button>
    </div>
  </div>
</form>

<!-- Results -->
<div id="feasResults" class="{% if not feas_result %}hidden{% endif %}">
  {% if feas_result %}
    {% set pr = feas_result.profitability %}
    {% set pa = feas_result.purchase_analysis %}
    {% set mp = feas_result.max_purchase_price %}

    <div class="stat-grid mb-3">
      <div class="stat-card">
        <div class="stat-label">Net Profit</div>
        <div class="stat-value {% if pr.net_profit >= 0 %}positive{% else %}negative{% endif %}">${{ "{:,.0f}".format(pr.net_profit|default(0)) }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ROI</div>
        <div class="stat-value">{{ pr.roi_pct|default(0) }}%</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Margin</div>
        <div class="stat-value">{{ pr.margin_pct|default(0) }}%</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Max Purchase</div>
        <div class="stat-value">${{ "{:,.0f}".format(mp.max_purchase_to_hit_target|default(0)) }}</div>
        <div class="stat-sub">For ${{ "{:,.0f}".format(mp.target_profit|default(0)) }} profit</div>
      </div>
    </div>

    <!-- Cost Breakdown -->
    <div class="card mb-3">
      <div class="card-header"><span class="card-title">Cost Breakdown</span></div>
      <div class="card-body">
        <ul class="kv-list">
          <li class="kv-item"><span class="kv-key">Purchase Price</span><span class="kv-val">${{ "{:,.0f}".format(pa.purchase_price|default(0)) }}</span></li>
          <li class="kv-item"><span class="kv-key">Stamp Duty</span><span class="kv-val">${{ "{:,.0f}".format(pa.stamp_duty|default(0)) }}</span></li>
          <li class="kv-item"><span class="kv-key">Legal + B&P</span><span class="kv-val">${{ "{:,.0f}".format((pa.legal_conveyancing|default(0)) + (pa.building_pest_inspection|default(0))) }}</span></li>
          <li class="kv-item"><span class="kv-key">Renovation (incl contingency)</span><span class="kv-val">${{ "{:,.0f}".format(feas_result.renovation.total_reno_cost|default(0)) }}</span></li>
          <li class="kv-item"><span class="kv-key">Holding Costs</span><span class="kv-val">${{ "{:,.0f}".format(feas_result.holding_costs.total_holding_cost|default(0)) }}</span></li>
          <li class="kv-item"><span class="kv-key">Selling Costs</span><span class="kv-val">${{ "{:,.0f}".format(feas_result.selling.total_selling_cost|default(0)) }}</span></li>
          <li class="kv-item" style="border-top: 2px solid var(--gray-200); font-weight:700"><span class="kv-key">Total Cost In</span><span class="kv-val">${{ "{:,.0f}".format(pr.total_cost_in|default(0)) }}</span></li>
          <li class="kv-item" style="font-weight:700"><span class="kv-key">Sale Price</span><span class="kv-val">${{ "{:,.0f}".format(pr.estimated_sale_price|default(0)) }}</span></li>
          <li class="kv-item" style="font-weight:700"><span class="kv-key {% if pr.net_profit >= 0 %}positive{% else %}negative{% endif %}">Net Profit</span><span class="kv-val {% if pr.net_profit >= 0 %}positive{% else %}negative{% endif %}">${{ "{:,.0f}".format(pr.net_profit|default(0)) }}</span></li>
        </ul>
      </div>
    </div>

    <!-- Verdict -->
    {% if feas_result.go_no_go %}
    <div class="result-panel mb-3">
      <div class="flex items-center gap-1 mb-1">
        <div class="result-label">Verdict</div>
        <span class="badge {% if feas_result.go_no_go == 'GO' %}badge-success{% elif feas_result.go_no_go == 'MARGINAL' %}badge-warning{% else %}badge-danger{% endif %}">{{ feas_result.go_no_go }}</span>
      </div>
      <p style="font-size:13px; color:var(--text-secondary); margin-top:8px">{{ feas_result.reasoning|default('') }}</p>
    </div>
    {% endif %}

    <!-- Downloads + Approve -->
    <div class="flex gap-1 mb-3">
      <a href="/api/deals/{{ deal.id }}/outputs/feasibility_report.xlsx" class="btn btn-secondary" download>üìó Spreadsheet</a>
      <a href="/api/deals/{{ deal.id }}/outputs/feasibility_result.json" class="btn btn-secondary" download>üìÑ JSON</a>
      <a href="/api/deals/{{ deal.id }}/outputs/feasibility_summary.md" class="btn btn-secondary" download>üìù Summary</a>
    </div>

    <div class="approve-bar">
      <div class="approve-bar-text">
        {% if deal.feasibility_status == 'approved' %}
          ‚úÖ Feasibility approved.
        {% else %}
          ‚ö†Ô∏è Review all outputs. Currently <strong>draft</strong>.
        {% endif %}
      </div>
      <div class="flex gap-1">
        <button class="btn btn-secondary" onclick="approveFeasibility('{{ deal.id }}', false)">Keep as Draft</button>
        <button class="btn btn-primary" onclick="approveFeasibility('{{ deal.id }}', true)">‚úì Approve</button>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
